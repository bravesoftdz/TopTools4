Subject: Re: Screen capture
Date: Sat, 05 Jun 1999 14:42:50 -0700
From: Gary Vennie <gvennie@compuall.com>
Organization: Another Netscape Collabra Server User
Newsgroups: borland.public.cppbuilder.graphics

I picked this up somewhere along the line and incorporated it into one
of my apps. It's fast and works just fine.

void __fastcall TEPSForm::CaptureBtnClick(TObject *Sender)
{
// ensure no other form shadows this form
   FormStyle = fsStayOnTop;
   Refresh();
// Create a TCanvas object for the desktop DC.
   TCanvas* dtCanvas = new TCanvas;
   dtCanvas->Handle = GetDC(0);
// Create a new TBitmap object and set its
// size to the size of the form.
   Graphics::TBitmap* bitmap = new Graphics::TBitmap;
   bitmap->Width = Width;
   bitmap->Height = Height;

// Create a palette from the form's Canvas
// and assign that palette to the bitmap's
// Palette property.
   int nColors = GetDeviceCaps(Canvas->Handle, SIZEPALETTE);
   LOGPALETTE* logPal = (LOGPALETTE*)new Byte[sizeof(LOGPALETTE) +
(nColors - 1) *
       sizeof(PALETTEENTRY)];
   logPal->palVersion  = 0x300;
   logPal->palNumEntries = (Word)nColors;
   GetSystemPaletteEntries(Canvas->Handle,0, nColors,
logPal->palPalEntry);
   bitmap->Palette = CreatePalette(logPal);
   delete[] logPal;

// Copy a section of the screen from the
// desktop canvas to the bitmap.
   TRect src = BoundsRect;
   TRect dest = Rect(0, 0, Width, Height);
   bitmap->Canvas->CopyRect(dest, dtCanvas, src);

// Save it to disk.
   char buffer[256];
   GetWindowsDirectory(buffer, sizeof(buffer));
   AnsiString asFileName = FileSearch(ToFileEdit->Text + ".bmp",
         GetCurrentDir() + AnsiString(";") + AnsiString(buffer));
   if (asFileName.IsEmpty())
         bitmap->SaveToFile(ToFileEdit->Text + ".bmp");
   else
        Application->MessageBox("Choose another name","File
Exists",MB_OK|MB_ICONERROR);
// Clean up and go home.
   delete bitmap;
   delete dtCanvas;
   CaptureBtn->Enabled = true;
}

Michael Warner wrote:
>
> On Sat, 5 Jun 1999 14:36:47 +0200, "Mario Pérez" <oiram@oiram.com>
> wrote:
>
> >How can I capture the screen?
>
> GetDC(0) will give you a device context for the entire screen. Create
> a TCanvas and set its Handle to this, and you can use TCanvas mathods
> to copy from it to another.
>
> "You may look like we do
>  Talk like we do
>  But you know how it is
>  You're not one of us" - Peter Gabriel
